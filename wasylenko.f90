!---------------------------------------------------------------------- 
!---------------------------------------------------------------------- 
!   wasylenko :     Wasylenko's network of simplified HH-style neurons
!---------------------------------------------------------------------- 
!---------------------------------------------------------------------- 

SUBROUTINE FUNC(NDIM,U,ICP,PAR,IJAC,F,DFDU,DFDP)

    IMPLICIT NONE
    INTEGER, INTENT(IN) :: NDIM, ICP(*), IJAC
    DOUBLE PRECISION, INTENT(IN) :: U(NDIM), PAR(*)
    DOUBLE PRECISION, INTENT(OUT) :: F(NDIM)
    DOUBLE PRECISION, INTENT(INOUT) :: DFDU(NDIM,NDIM), DFDP(NDIM,*)
    DOUBLE PRECISION, dimension(NDIM/4) :: VTC, hTC, VRE, hRE, dVTCdt, dhTCdt, dVREdt, dhREdt, theSum
    INTEGER N, i, k, omega, neighbor
    DOUBLE PRECISION s, minf, Hinf, sinf, tauinf

    DOUBLE PRECISION ths, sigs, thh, sigh, thm, sigm, thtau, sigtau, tau1, tau2
    DOUBLE PRECISION gLTC, VLTC, VsynTC, gLRE, VLRE, epRE, VsynRE, gCa, Cm, v

    double precision epTC, gTC, gRE, VCa

    ths = -20
    sigs = 2
    thh = -79
    sigh = -5
    thm = -65
    sigm = 7.8
    thtau = -65
    sigtau = 4
    tau1 = 1
    tau2 = 80

    gLTC = .01
    VLTC = -75
    VsynTC = 0
    gLRE = .2
    VLRE = -80
    epRE = 2
    VsynRE = -80
    gCa = 1
    Cm = 1

    N = NDIM / 4

    VTC = U(1+0*N:1*N)
    hTC = U(1+1*N:2*N)
    VRE = U(1+2*N:3*N)
    hRE = U(1+3*N:4*N)

    s=PAR(1)
    epTC = 1 + 2 * s
    gTC = 0.03 + 0.07 * s
    gRE = 0.1 + 0.2 * s
    VCa = 120 - 30 * s

    omega = 6

    theSum = 0d0
    do i=1,N
        do k=-omega,omega
            neighbor = i + k
            if (neighbor > N) then
                 neighbor = neighbor - N
            endif
            if (neighbor <= 0) then
                neighbor = N + neighbor
            endif
            theSum(i) = theSum(i) + sinf(VTC(neighbor))
        end do
    end do

    do i=1,N
      dVTCdt(i) = (-gLTC * (VTC(i) - VLTC) &
                  -gCa * (minf(VTC(i))) ** 3 * hTC(i) * (VTC(i) - VCa) &
                  -gTC * sinf(VRE(i)) * (VTC(i) - VsynRE) &
                  ) / Cm
      dhTCdt(i) = epTC * (hinf(VTC(i)) - hTC(i)) / tauinf(VTC(i))
      dVREdt(i) = (-gLRE * (VRE(i) - VLRE) &
                  -gCa * (minf(VRE(i))) ** 3 * hRE(i) * (VRE(i) - VCa) &
                  -gRE / (2*omega+1) * theSum(i) * (VRE(i) - VsynTC) &
                 ) / Cm
      dhREdt(i) = epRE * (hinf(VRE(i)) - hRE(i)) / tauinf(VRE(i))
    end do

!    i = 4
!    print *, "PAR(11):", PAR(11)
!    print *, "df(4):", dVTCdt(i), dhTCdt(i), dVREdt(i), dhREdt(i)
!    print *, "f(4):", VTC(4), hTC(4), VRE(4), hRE(4), "s:", s, "pd:", PAR(11)

    do i=1,N
        F(0*N + i) = dVTCdt(i)
        F(1*N + i) = dhTCdt(i)
        F(2*N + i) = dVREdt(i)
        F(3*N + i) = dhREdt(i)
    end do


END SUBROUTINE FUNC

SUBROUTINE STPNT(NDIM,U,PAR,T)

      IMPLICIT NONE
      INTEGER, INTENT(IN) :: NDIM
      DOUBLE PRECISION, INTENT(INOUT) :: U(NDIM),PAR(*)
      DOUBLE PRECISION, INTENT(IN) :: T
      INTEGER N, i

      N = NDIM / 4

       PAR(1)=0.5
!       PAR(11)=570.6  ! override Auto's choice of period

! ! Initial steady solution
!    do i=1,N
!      U(0*N + i) = -50
!      U(1*N + i) = 0.002
!      U(2*N + i) = -78
!      U(3*N + i) = 0.5
!    end do

! ! Initial traveling-wave solution (for s=0.5)
if (0==0) then  ! do 0==0 to effectively comment out this solution.
    U(1) = -70.5094021145
    U(2) = -69.3101972325
    U(3) = -62.3781751416
    U(4) = -48.9366309922
    U(5) = -48.9941659965
    U(6) = -49.0539248923
    U(7) = -49.1118186628
    U(8) = -49.1576229968
    U(9) = -49.176441673
    U(10) = -49.1562217519
    U(11) = -49.0947918163
    U(12) = -48.9901136134
    U(13) = -48.8375155384
    U(14) = -48.6408416588
    U(15) = -48.4215141027
    U(16) = -48.2169982839
    U(17) = -48.057219084
    U(18) = -47.9633244775
    U(19) = -47.9709106663
    U(20) = -48.1242634463
    U(21) = -48.4469763782
    U(22) = -48.9141309981
    U(23) = -49.4843118144
    U(24) = -50.1216851787
    U(25) = -50.7488760523
    U(26) = -51.2285410435
    U(27) = -51.407287297
    U(28) = -51.1959193827
    U(29) = -50.5552151245
    U(30) = -49.4216064592
    U(31) = -47.7363140311
    U(32) = -45.5149521161
    U(33) = -42.8847063612
    U(34) = -39.9771033293
    U(35) = -36.7677065263
    U(36) = -33.164325608
    U(37) = -29.1322379033
    U(38) = -24.7388777574
    U(39) = -20.137816996
    U(40) = -15.3833273741
    U(41) = -10.3408018014
    U(42) = -4.88134839403
    U(43) = 0.992156258228
    U(44) = 7.12131867615
    U(45) = 13.2868574954
    U(46) = 19.4621254733
    U(47) = 25.7832601141
    U(48) = 32.2957774409
    U(49) = 38.8676395468
    U(50) = 45.2239285956
    U(51) = 51.1334918902
    U(52) = 56.5946925896
    U(53) = 61.6160346649
    U(54) = 65.9251877045
    U(55) = 68.8773237086
    U(56) = 69.2286061411
    U(57) = 64.584916901
    U(58) = 48.9992918035
    U(59) = 4.82427135131
    U(60) = -66.4532521544
    U(61) = 0.118309630816
    U(62) = 0.045797991908
    U(63) = 0.0054664033221
    U(64) = 0.00247815132763
    U(65) = 0.00248474272687
    U(66) = 0.00248496966132
    U(67) = 0.00247681274845
    U(68) = 0.00245773035686
    U(69) = 0.00242692068118
    U(70) = 0.00238776048173
    U(71) = 0.00234582630612
    U(72) = 0.00230409859698
    U(73) = 0.00226666134513
    U(74) = 0.00224132161656
    U(75) = 0.00223730105385
    U(76) = 0.00225995738139
    U(77) = 0.00230950156803
    U(78) = 0.00238806386491
    U(79) = 0.00249858648076
    U(80) = 0.00263768281726
    U(81) = 0.00278952147997
    U(82) = 0.00292772274998
    U(83) = 0.00302898948646
    U(84) = 0.00306693423986
    U(85) = 0.00300047344863
    U(86) = 0.00279033573061
    U(87) = 0.00243823543286
    U(88) = 0.00200085966972
    U(89) = 0.00153900053871
    U(90) = 0.00110208044779
    U(91) = 0.000740666992127
    U(92) = 0.000488694696293
    U(93) = 0.000346067993966
    U(94) = 0.000285625143374
    U(95) = 0.000279854108771
    U(96) = 0.000314828518269
    U(97) = 0.000385451008626
    U(98) = 0.000490017865337
    U(99) = 0.000627313176052
    U(100) = 0.000799994145309
    U(101) = 0.00102113713595
    U(102) = 0.00131206359542
    U(103) = 0.00169680001987
    U(104) = 0.00219541459839
    U(105) = 0.00282118188891
    U(106) = 0.00360328681645
    U(107) = 0.00460902409731
    U(108) = 0.00593262004622
    U(109) = 0.00767429409704
    U(110) = 0.009913556883
    U(111) = 0.0127178137553
    U(112) = 0.0162480276479
    U(113) = 0.0208162796299
    U(114) = 0.0268284777552
    U(115) = 0.0346971392078
    U(116) = 0.0447453100594
    U(117) = 0.0573340647397
    U(118) = 0.0732963391608
    U(119) = 0.0940465825098
    U(120) = 0.121496061953
    U(121) = -7.75076233855
    U(122) = 1.68143015094
    U(123) = 11.2743727962
    U(124) = -42.9827722768
    U(125) = -75.510660966
    U(126) = -78.521497477
    U(127) = -78.5214922901
    U(128) = -78.5214865997
    U(129) = -78.5214805493
    U(130) = -78.5214750855
    U(131) = -78.5214722521
    U(132) = -78.5214692072
    U(133) = -78.5214663969
    U(134) = -78.5214643315
    U(135) = -78.5214633848
    U(136) = -78.5214636464
    U(137) = -78.5214650214
    U(138) = -78.5214673549
    U(139) = -78.5214704705
    U(140) = -78.5214741637
    U(141) = -78.5214780287
    U(142) = -78.5214808168
    U(143) = -78.5214780796
    U(144) = -78.5214521716
    U(145) = -78.5213270322
    U(146) = -78.5207687096
    U(147) = -78.5184056933
    U(148) = -78.5090382734
    U(149) = -78.4726340968
    U(150) = -78.3292625827
    U(151) = -77.7774316277
    U(152) = -75.9524904053
    U(153) = -72.063667829
    U(154) = -67.7131290251
    U(155) = -63.8266027293
    U(156) = -60.3919001252
    U(157) = -57.3083837732
    U(158) = -54.4937477668
    U(159) = -51.8968641885
    U(160) = -49.4892387175
    U(161) = -47.2513134183
    U(162) = -45.1636505537
    U(163) = -43.2090783538
    U(164) = -41.3940847497
    U(165) = -39.8748920124
    U(166) = -39.0895149347
    U(167) = -38.7562648789
    U(168) = -38.4231665239
    U(169) = -37.9841109469
    U(170) = -37.4008639574
    U(171) = -36.6570562619
    U(172) = -35.7454584633
    U(173) = -35.0180918111
    U(174) = -34.8323406103
    U(175) = -34.0600872624
    U(176) = -32.5034969017
    U(177) = -30.0624099096
    U(178) = -26.6395157997
    U(179) = -21.963965715
    U(180) = -15.7146905424
    U(181) = 0.115641390472
    U(182) = 0.149691366276
    U(183) = 0.192272548388
    U(184) = 0.245393473331
    U(185) = 0.416374191357
    U(186) = 0.476093079464
    U(187) = 0.476092816405
    U(188) = 0.476092528634
    U(189) = 0.476092227842
    U(190) = 0.476091976253
    U(191) = 0.476091831907
    U(192) = 0.476091680636
    U(193) = 0.476091545456
    U(194) = 0.476091451255
    U(195) = 0.476091414783
    U(196) = 0.476091438466
    U(197) = 0.476091516412
    U(198) = 0.476091640474
    U(199) = 0.476091801769
    U(200) = 0.476091989188
    U(201) = 0.476092177478
    U(202) = 0.476092285214
    U(203) = 0.476092019273
    U(204) = 0.476090207238
    U(205) = 0.47608176876
    U(206) = 0.476044354417
    U(207) = 0.475886219923
    U(208) = 0.475260308251
    U(209) = 0.472832448149
    U(210) = 0.463256515219
    U(211) = 0.425605918312
    U(212) = 0.299173409151
    U(213) = 0.118479549018
    U(214) = 0.0401047055078
    U(215) = 0.0165084585877
    U(216) = 0.00822534702083
    U(217) = 0.00467819405093
    U(218) = 0.00295899009603
    U(219) = 0.00208510495739
    U(220) = 0.00165310521769
    U(221) = 0.00147893175613
    U(222) = 0.00148263138186
    U(223) = 0.0016352138738
    U(224) = 0.00193057184542
    U(225) = 0.00236382232238
    U(226) = 0.00292362283025
    U(227) = 0.00363214167455
    U(228) = 0.00456316790338
    U(229) = 0.00581218543297
    U(230) = 0.00746826748492
    U(231) = 0.00957649225581
    U(232) = 0.0121830284561
    U(233) = 0.0154850472236
    U(234) = 0.0198230964196
    U(235) = 0.0255994029161
    U(236) = 0.0331583376317
    U(237) = 0.0426688366228
    U(238) = 0.0544543805368
    U(239) = 0.0695073299833
    U(240) = 0.089348620135
end if



END SUBROUTINE STPNT

SUBROUTINE BCND 
END SUBROUTINE BCND

SUBROUTINE ICND 
END SUBROUTINE ICND

SUBROUTINE FOPT 
END SUBROUTINE FOPT

SUBROUTINE PVLS
END SUBROUTINE PVLS

DOUBLE PRECISION function minf(v)
    IMPLICIT NONE
    DOUBLE PRECISION, INTENT(IN) :: v
    double precision thm, sigm
    thm = -65
    sigm = 7.8
    minf = 1 / (1 + exp(-(v - thm) / sigm))
END FUNCTION
    
DOUBLE PRECISION function hinf(v)
    IMPLICIT NONE
    DOUBLE PRECISION, INTENT(IN) :: v
    double precision thh, sigh
    thh = -79
    sigh = -5
    hinf = 1 / (1 + exp(-(v - thh) / sigh))
END FUNCTION
    
DOUBLE PRECISION function sinf(v)
    IMPLICIT NONE
    DOUBLE PRECISION, INTENT(IN) :: v
    double precision ths, sigs
    ths = -20
    sigs = 2
    sinf = 1 / (1 + exp(-(v - ths) / sigs))
END FUNCTION
     
DOUBLE PRECISION function tauinf(v)
    IMPLICIT NONE
    DOUBLE PRECISION, INTENT(IN) :: v
    double precision tau1, tau2, thtau, sigtau
    tau1 = 1
    tau2 = 80
    thtau = -65
    sigtau = 4
    tauinf = tau1 + (tau2 - tau1) / (1 + exp(-(v - thtau) / sigtau))
END FUNCTION


